class Analyzer{constructor(){return this}static init(e){return this.Report=Report.new(e).init(),this}static roundNb(e){let t=this.Report.Options.Decimals.Selected;return void 0===e.toFixed||"All"==t?e:e.toFixed(t)}static logValue(e){let t=Math.log10(e.Value);return this.Report.Options.Shift.getValue()?t+Unit.shiftForUnit(e.Unit):t}static isNumeric(e){return Decimal.isNumeric(e)}static divHeight(e){return 1.65*(e+.5)+"em"}static rowWidth(e,t){let a=t*e*.9*(1-.2*t/20);return a=Math.max(a,2),a+"em"}static noData(e){switch(e){case"txt":return"Ã˜";default:return'<span class="Warning">&Oslash;</span>'}}static header(e,t){if(e.Unit){let a=e.Unit;switch(t.Log&&(a=this.headerConcLog(e.Unit,t.Format,t.Shift)),t.Format){case"html":return'<span class="Header_Conc" name="'+e.Unit+'">'+a+"</span>";case"txt":return a}}return e.Name}static headerConcLog(e,t,a){switch(a&&(e=Unit.rootForUnit(e)),t){case"html":return"Log<sub>10</sub>("+e+")";case"txt":return"Log10("+e+")"}}static valueHeader(e,t,a,s){let i="";if(a)switch(t.Format){case"html":i="Row"==s?' rowspan="'+a+'"':' colspan="'+a+'"';break;case"txt":void 0!==s&&"Col"!=s||(i=Analyzer.blankCell("txt").repeat(a-1))}if("Conc"==e.Type){let a=this.logValue(e),s="";switch(t.Format){case"html":return s=t.Log?this.roundNb(a):"MOI"==e.Unit?e.Value:this.roundNb(e.Value),"<th"+i+' class="Value_PlaceHolder Header_Conc" value="'+e.Value+'" logvalue="'+a+'" shift="'+Unit.shiftForUnit(e.Unit)+'">'+s+"</th>";case"txt":return t.Log?t.Displayed?this.roundNb(a)+i+"\t":a+i+"\t":t.Displayed?"MOI"==e.Unit?e.Value+i+"\t":this.roundNb(e.Value)+i+"\t":e.Value+i+"\t"}}if("Range"==e.Type){if(t.GenericRangeName)switch(t.Format){case"html":return"<th"+i+">"+e.Name+"</th>";case"txt":return e.Name+i+"\t"}let a=this.Report.ResolvedNames[e.OriginIndex];if(void 0!==a){let s=a[e.RangeIndex-1];if(void 0!==s)switch(t.Format){case"html":return"<th"+i+' class="Value_PlaceHolder Header_Range" RootName="'+e.Name+'">'+s+"</th>";case"txt":return s+i+"\t"}}}switch(t.Format){case"html":return"<th"+i+">"+e.Name+"</th>";case"txt":return e.Name+i+"\t"}}static cellForValue(e,t,a){if("txt"==t.Format){if(""===e||null==e)return this.noData("txt");let a=e;return void 0!==e.Value&&(a=e.Value),t.Displayed?this.roundNb(a):a}let s=' class="',i=e,n="",l="";if(""!==e&&null!=e||(i=this.noData(t.Format)),a&&(a.Class&&(s+=a.Class+" "),a.Border&&a.Index>0&&(s+="BorderLeft "),"#"==a.Type&&""!==e&&null!=e&&(i=this.roundNb(e),s+="Value_PlaceHolder",n=' value="'+e+'"'),a.Title&&(l=' title="'+a.Title+'"'),a.ReturnLength)){let t="<td"+s+'"'+n+l+">"+i+"</td>";return""===e||null==e?{HTML:t,Length:2}:void 0===i.length?{HTML:t,Length:i.toString().length}:{HTML:t,Length:i.length}}return"<td"+s+'"'+n+l+">"+i+"</td>"}static arrayToRow(e,t,a){let s="",i=0;if(0==e.length)switch(t.Format){case"txt":s+=this.noData("txt");break;case"html":s+="<td>"+this.noData()+"</td>"}if("txt"==t.Format){if(e.forEach((function(e,i){i>0&&(s+="\t"),s+=this.cellForValue(e,t,a)}),this),void 0!==a.ColumnLength){let t=a.ColumnLength-e.length;0==e.length&&t--,t>0&&(s+=this.blankCell("txt").repeat(t))}return s}return e.forEach((function(e,n){let l={Border:!0,Index:n,ReturnLength:!0};a&&(a.Types&&(l.Type=a.Types[n]),a.Titles&&(l.Title=a.Titles[n]));let r=this.cellForValue(e,t,l);s+=r.HTML,i=Math.max(i,r.Length)}),this),'<td class="Border"><div class="InnerTable_Wrapper"><table class="InnerTableRow" style="min-width: '+this.rowWidth(e.length,i)+'"><tr>'+s+"</tr></table></div></td>"}static arrayToColumn(e,t,a,s){switch(a.Format){case"txt":return this.arrayToColumn_Txt(e,t,a,s);case"html":let i="";return t.Groups.forEach((function(t,s){i+=this.arrayToColumn_HTML(t.DataPoints[e],a),a.ColumnIndex++}),this),i}}static arrayToColumn_Txt(e,t,a,s){console.log(e,t,a,s);let i="",n=t.Groups.reduce((function(t,a){return Math.max(t,a.DataPoints[e].length)}),0),l=this.blankCell("txt");if(void 0!==a.Gap?l=this.blankCell("txt").repeat(a.Gap):null!=s&&void 0!==s.Rows&&(l+=this.blankCell("txt")),0==n)return this.noData("txt");for(let s=0;s<n;s++)s>0&&(i+="\n"+l),t.Groups.forEach((function(t){let n=t.DataPoints[e][s];void 0!==n?i+=this.cellForValue(n,a,{Type:"#"}):0==s&&(i+=this.noData("txt")),i+="\t"}),this);return i}static arrayToColumn_HTML(e,t){let a=this.Report.Options,s="";if(a.Collapse.getValue()){let t=a.Rows.getValue();s=' style="max-height: '+this.divHeight(t),e.length<=t?s+='; overflow-y: unset"':s+='; overflow-y: scroll"'}let i=e.length,n='<td class="Border" style="vertical-align: top">';return n+='<div class="InnerTable_Wrapper"'+s,t.Sync&&(n+=' onmouseenter="Analyzer.scrollActive = '+t.ColumnIndex+'" onscroll="Analyzer.syncScrolling()"'),n+='><table class="InnerTable">',e.forEach((function(e,a){let s=e,i={Type:"#"};null!=e&&(void 0!==e.Value&&(s=e.Value),void 0!==e.Class&&(i.Class=e.Class),void 0!==e.Type&&(i.Type=e.Type)),0==this.isNumeric(s)&&(i.Type="Text"),n+="<tr>"+this.cellForValue(s,t,i)+"</tr>"}),this),0==i&&(n+="<tr><td>"+this.noData()+"</td></tr>"),n+="</table></div></td>",n}static syncScrolling(){let e=event.target,t=e.parentElement,a=t.cellIndex-1,s=this.scrollActive;if(s==a){this.Scroll=e.scrollTop;let a=t.parentElement.getElementsByClassName("InnerTable_Wrapper"),i=a.length;for(let e=0;e<i;e++)if(e!=s){a[e].scrollTop=this.Scroll}}}static getConfig(e){let t=void 0;return void 0!==this.Report.Options.LogScale&&(t=this.Report.Options.LogScale.getValue()),{Displayed:1==this.Report.Options.ExportFormat.getValue(),Log:t,Format:e,CV:this.Report.Options.CV.getValue(),Shift:this.Report.Options.Shift.getValue(),Aggregation:this.Report.UI.DataView.Selected,ColumnIndex:0}}static encodeJSON(e,t,a){let s={Data:[]},i={Lvl1:{Rows:[],Cols:[]},Lvl2:{Rows:[],Cols:[]}},n=GroupTable.flattenLevel(e[0],i.Lvl1.Rows),l=GroupTable.flattenLevel(t[0],i.Lvl1.Cols);return void 0===n&&void 0===l||(s.Headers={Rows:n,Cols:l}),GroupTable.prepareWrapping(e,t,i,s),GroupTable.populateData(s.Data,a),s}static exportJSON(e,t){let a=this.getConfig(t);if(e.SyncScrolling&&(a.Sync=!0),e.GenericRangeName&&(a.GenericRangeName=!0),e.Wrapping){return new WrapTable(e.Wrapping).export(e,a)}return GroupTable.export(e,a,e.Headers)}static tableStart(e){return"html"==e?'<table class="OuterTable">':""}static tableEnd(e){return"html"==e?"</table>":""}static rowStart(e){return"html"==e?"<tr>":""}static rowEnd(e){switch(e){case"html":return"</tr>";case"txt":return"\n"}}static blankCell(e){switch(e){case"html":return"<td></td>";case"txt":return"\t"}}static blankHeader(e,t){switch(e){case"html":let e="";return t&&(e="Row"==t.Dir?' rowspan="'+t.Span+'"':' colspan="'+t.Span+'"'),"<th"+e+"></th>";case"txt":return"\t"}}}class Bloc{constructor(e){return this.ID=e.ID,this.Name=e.Name,this.File=e.File,this.Sections=[],this.SectionsTab=new TabControl({ID:e.ID,Multiple:!0,Layout:"Horizontal",Tabs:[]}),this}init(){return this.SectionsTab.init(),this}getSection(e,t){let a=!1,s=0,i=this.Sections,n=i.length;for(;!a&&s<n;)i[s].Name==e?a=!0:s++;if(a){let a=this.Sections[s];return void 0===t||"Multiple"!=t.Type&&"StatsTable"!=t.Type||0==t.Changed?a:this.resetSection(e,s,t)}return this.newSection(e,s,t)}newSection(e,t,a){let s=this.initSection(e,t,a);return this.Sections.push(s),this.SectionsTab.addTab({Label:e,SetActive:!0,Content:{Type:"HTML",Value:s.HTML(e)}}),s.activateControls(),s}initSection(e,t,a){let s={Name:e,Bloc:this,ID:this.ID+"_"+t};return a&&Object.assign(s,a),new Section(s)}resetSection(e,t,a){let s=this.initSection(e,t,a);return this.Sections[t]=s,this.SectionsTab.Tabs[t].updateContent({Type:"HTML",Value:s.HTML(e)}),s.activateControls(),s}}class CustomTable{constructor(e,t){return this.ID=e,this.Data=t,this.Title=t.Title,this}get TitleExport(){return void 0===this.Title?"":this.Title}html(){let e="";return e+='<div id="'+this.ID+'" class="DynTable_Wrap">',void 0!==this.Title&&(e+='<fieldset class="DynTable_Container">',e+='<legend class="DynTable_Title">'+this.Title+"</legend>"),e+=Analyzer.exportJSON(this.Data,"html"),void 0!==this.Title&&(e+="</fieldset>"),e+="</div>",e}buildJSON(){return this.Data}addRow(e,t){return this.hasData(t)||this.Data.Data[0].Groups.forEach((function(t,a){t.DataPoints[0].push(e.Data[0].Groups[a].DataPoints[0][0])})),this}hasData(e){let t=!1,a=this.Data.Data[0].Groups[0].DataPoints[0],s=0,i=a.length;for(;!1===t&&s<i;)a[s]==e&&(t=!0),s++;return t}resetSection(e,t,a){console.log("resetSection not implemented for CustomTable. SO GET YOUR FINGERS OUT OF YOUR ASS MOTHERFUCKER!!!")}}class Group{constructor(e){return this.DataPoints=[],this.Name=e.Name||"",this.Value=e.Value,this.Tags=e.Tags||[],this.RangeIndex=e.RangeIndex,this.OriginIndex=e.OriginIndex,this.Type=e.Type,this.Unit=e.Unit,this}static newTyped(e,t,a){let s=new Group(e);return s.Type=t,"Conc"==t&&(s.Unit=s.Name),"Range"==t&&(s.OriginIndex=a.OriginIndex),a&&a.SetNameAsValue&&(s.Name=e.Value.toString()),s}static colHeaders(e,t){let a="",s=0;return e.forEach((function(e,i){let n=0;if("txt"==t.Format){let a=0,i=1;for(null!=e&&(i=e.Span);a<i;){switch(t.Aggregation){case"Row":let e=t.ColumnsLength[s+a];e>0?n+=e:n++;break;case"Avg, SD, N":n+=3;break;default:n++}a++}s+=a}if(null!=e){let s=e.Span;switch(t.Format){case"html":a+='<th colspan="'+s+'">'+Analyzer.header(e,t)+"</th>";break;case"txt":a+=Analyzer.header(e,t),a+=Analyzer.blankCell("txt").repeat(n)}}else switch(t.Format){case"html":a+=Analyzer.blankHeader("html");break;case"txt":a+=0==n?Analyzer.blankCell("txt"):Analyzer.blankCell("txt").repeat(n)}})),a}static colValueHeaders(e,t){let a="";return e.Groups.length>0?e.Groups.forEach((function(e,s){let i=1;if("txt"==t.Format)switch(t.Aggregation){case"Row":i=t.ColumnsLength[s];break;case"Avg, SD, N":i=3}a+=Analyzer.valueHeader(e,t,i)})):a+=Analyzer.blankHeader(t.Format),a}}class GroupTable{constructor(){}static flattenSeries(e,t){switch(e.Category){case"Concentrations":return e.Values.forEach((function(e){t.push(Group.newTyped(e,"Conc",{SetNameAsValue:!0}))})),{Type:"Conc",Name:e.Name,Span:e.Values.length,Unit:e.Unit};case"Ranges":return e.Values.forEach((function(a){t.push(Group.newTyped(a,"Range",{OriginIndex:e.OriginIndex}))})),{Type:"Range",Name:e.Name,Span:e.Values.length,OriginIndex:e.OriginIndex};default:return void t.push(new Group(e))}}static flattenLevel(e,t){let a=[],s=!1;if(e.forEach((function(e){let i=this.flattenSeries(e,t);a.push(i),void 0!==i&&(s=!0)}),this),s)return a}static intersect(e,t){let a=e,s=t;e.length>t.length&&(a=t,s=e);let i=s.slice();return a.filter((function(e){let t=i.findIndex((function(t){return t==e}));return t>-1&&(i.splice(t,1),!0)}))}static mergeTags(e,t){let a=[];return e.forEach((function(e){let s=new Group(e);s.Tags=this.intersect(e.Tags,t),a.push(s)}),this),a}static prepareWrapping(e,t,a,s){let i=void 0,n=void 0;if(e[1].length>0?(i=this.flattenLevel(e[1],a.Lvl2.Rows),a.Lvl2.Rows.forEach((function(e){let t=this.mergeTags(a.Lvl1.Rows,e.Tags);s.Data.push({SubGroups:t,Groups:[]})}),this)):s.Data.push({SubGroups:a.Lvl1.Rows,Groups:[]}),t[1].length>0){n=this.flattenLevel(t[1],a.Lvl2.Cols);let e=[];a.Lvl2.Cols.forEach((function(t){let i=this.mergeTags(a.Lvl1.Cols,t.Tags);s.Data.forEach((function(t){let a=i.map((function(e){return new Group(e)}));e.push({SubGroups:t.SubGroups,Groups:a})}))}),this),s.Data=e}else s.Data.forEach((function(e){e.Groups=a.Lvl1.Cols.map((function(e){return new Group(e)}))}));(e[1].length>0||t[1].length>0)&&(s.Wrapping={Data:{SubGroups:a.Lvl2.Rows,Groups:a.Lvl2.Cols}},void 0===n&&void 0===i||(s.Wrapping.Headers={Rows:i,Cols:n}))}static populateData(e,t){e.forEach((function(e){e.Groups.forEach((function(a){let s=a.Tags;e.SubGroups.length>0?e.SubGroups.forEach((function(e){let i=this.intersect(e.Tags,s).map((function(e){return t[e]}));a.DataPoints.push(i)}),this):a.DataPoints.push(s.map((function(e){return t[e]})))}),this)}),this)}static export(e,t,a){let s="",i=t.Format,n=e.Data[0];t.ColumnsLength=n.Groups.map((function(e){return e.DataPoints.reduce((function(e,t){return Math.max(e,t.length)}),0)})),s+=Analyzer.tableStart(i),s+=this.export_ColHeaders(n,t,a);let l={Index:0,HeaderIndex:0};return n.SubGroups.length>0?n.SubGroups.forEach((function(e,r){s+=Analyzer.rowStart(i),s+=this.export_RowHeader(e,r,l,t,a),s+=this.export_RowData(r,n,t,a),s+=Analyzer.rowEnd(i)}),this):(s+=Analyzer.rowStart(i),s+=Analyzer.blankCell(i),s+=this.export_RowData(0,n,t,a),s+=Analyzer.rowEnd(i),e.StatRows&&(s+=WrapTable.export_StatRows(e,t))),s+=Analyzer.tableEnd(i),s}static export_ColHeaders(e,t,a,s){let i="",n="",l=t.Format;return s&&(n=Analyzer.blankCell(l).repeat(s)),void 0!==a&&(void 0!==a.Rows&&(n+=Analyzer.blankCell(l)),void 0!==a.Cols&&(i+=Analyzer.rowStart(l),i+=n+Analyzer.blankCell(l),i+=Group.colHeaders(a.Cols,t),i+=Analyzer.rowEnd(l))),i+=Analyzer.rowStart(l),i+=n+Analyzer.blankCell(l),i+=Group.colValueHeaders(e,t),i+=Analyzer.rowEnd(l),i}static export_RowHeader(e,t,a,s,i){let n="";if(void 0!==i&&void 0!==i.Rows)if(t==a.Index){let e=i.Rows[a.HeaderIndex];if(null!=e){switch(s.Format){case"html":n+='<th rowspan="'+e.Span+'">'+Analyzer.header(e,s)+"</th>";break;case"txt":n+=Analyzer.header(e,s)+"\t"}a.Index+=e.Span}else n+=Analyzer.blankHeader(s.Format),a.Index+=1;a.HeaderIndex++}else"txt"==s.Format&&(n+=Analyzer.blankCell("txt"));return n+=Analyzer.valueHeader(e,s),n}static export_RowData(e,t,a,s){let i="";return"Column"==a.Aggregation?Analyzer.arrayToColumn(e,t,a,s):(t.Groups.forEach((function(t,s){s>0&&"txt"==a.Format&&(i+="\t");let n=Coordinate.statValue(t.DataPoints[e]);switch(a.Aggregation){case"Row":i+=Analyzer.arrayToRow(t.DataPoints[e],a,{Types:Array(t.DataPoints[e].length).fill("#"),ColumnLength:a.ColumnsLength[s]});break;case"Average":i+=Analyzer.cellForValue(n.Average,a,{Class:"BorderSpaced",Type:"#"});break;case"Avg, SD, N":i+=Analyzer.arrayToRow([n.Average,n.SD,n.N],a,Coordinate.headerObject("Row"))}})),i)}}class Report{constructor(e,t){this.Title=e.Title,this.Anchors={Output:"Output",Menu:"Menu",Options:"Options",Export:"Export",Results:"Results",PlateSelect:"PlateSelect",ResultPlate:"ResultPlate",PlateDoAll:"PlateDoAll",PairingTarget:"PairingTarget"};let a="";return a+='<div id="'+this.Anchors.Menu+'"></div>',a+='<div id="'+this.Anchors.Output+'"></div>',GetId("Main").innerHTML=a,this.ResolvedNames=[],this.Results=new RespTable({ID:this.Anchors.Results,Array:window.opener.Results.map((function(e){return e.LoggedPlate=0,e})),Fields:["Name","Size","Info"],Headers:["Name","Size","Parameters"],onSelect:function(e,t,a,s){a[0]!=s[0]&&(Report.saveState(this,s[0]),this.setPlates().do(),Report.restoreState(this,a[0]))}.bind(this),FullWidth:!0,RowNumbers:!0,NoControls:!0}),this.Blocs=[],this.Output=new TabControl({ID:this.Anchors.Output,Layout:"Horizontal",Tabs:[]}),this.Menu=new TabControl({ID:this.Anchors.Menu,Multiple:!0,Layout:"Menu",Tabs:[{Label:"Options",Active:!0,Content:{Type:"HTML",Value:'<div id="'+this.Anchors.Options+'"></div>'}},{Label:"Export",Active:!0,Content:{Type:"HTML",Value:'<div id="'+this.Anchors.Export+'"></div>'}},{Label:"Results",Active:!0,Content:{Type:"HTML",Value:'<div id="'+this.Anchors.Results+'"></div>'}},{Label:"Plates",Active:!0,Content:{Type:"HTML",Value:'<fieldset id="'+this.Anchors.PlateSelect+'"><legend>Result</legend><div id="'+this.Anchors.ResultPlate+'"></div><div style="text-align: center; margin-bottom: 5px;" id="'+this.Anchors.PairingTarget+'"></div><div id="'+this.Anchors.PlateDoAll+'" style="text-align: center;"></div></fieldset>'}}]}),this.Options={Collapse:LinkCtrl.new("Checkbox",{ID:this.Anchors.Options,Label:"Collapse tables",Default:!0,Chain:{Index:0},Change:function(e){let t=this.Options.Rows;e?t.enable():t.disable(),this.refresh("Rows",{Collapse:e,Rows:t.getValue()})}.bind(this),Title:"Tick to limit the number of rows displayed in tables"}),Rows:LinkCtrl.new("Number",{ID:this.Anchors.Options,Label:"Rows",Default:10,Min:2,Step:1,Chain:{Index:1,Last:!0},Change:function(e){this.refresh("Rows",{Collapse:!0,Rows:e})}.bind(this),Title:"Maximum number of rows to show for each table"}),Decimals:LinkCtrl.new("Select",{ID:this.Anchors.Options,Label:"Decimals",Default:3,List:[0,1,2,3,4,5,6,"All"],Chain:{Index:2,NewLine:!0},Change:function(e){this.refresh("Decimals")}.bind(this),Title:"Number of decimals to show for the computed values. Parsed values from the file are not affected"}),CV:LinkCtrl.new("Checkbox",{ID:this.Anchors.Options,Label:"Show CV",Default:!1,Chain:{Index:3,Last:!0},Change:function(e){this.refresh("CV",{Show:e})}.bind(this),Title:"Tick to show the coefficient of varation (CV, %) for the data"}),ExportFormat:LinkCtrl.new("Radio",{ID:this.Anchors.Export,Default:0,Label:"Export values",List:["Raw","Displayed"],Title:"Controls whether the exported data should be as they appear in the file or after calculation (Raw), or as they appear in the table with the decimal formatting applied (Displayed)"})},this.Options.LogScale=LinkCtrl.new("Checkbox",{ID:this.Anchors.Options,Label:"Log Scale",Default:!1,Chain:{Index:4,NewLine:!0},Change:function(e){this.refresh("Log")}.bind(this),Title:"Tick to show the concentration data in log scale"}),this.Options.Shift=LinkCtrl.new("Checkbox",{ID:this.Anchors.Options,Label:"Shift unit",Default:!1,Chain:{Index:5,Last:!0},Change:function(e){this.refresh("Log")}.bind(this),Title:"Tick to shift the concentration data to their closest parent value (i.e. M or g/mL) when using the log scale"}),this.UI={Plate:LinkCtrl.new("Select",{ID:this.Anchors.ResultPlate,Default:0,List:[],Label:"Plate",Change:function(e){this.Result.LoggedPlate=e,this.pairStatus(e),this.do()}.bind(this),Title:"The result plate for which values will be displayed"})},this.Menu.init(),this.Output.init(),this.Results.init(),Object.values(this.Options).forEach((function(e){e.init()})),GetId(this.Anchors.Export).append(LinkCtrl.buttonBar([{Label:"Export All",Title:"Export all the data generated by the report, as a zip file containing tab-delimited text files",Click:this.exportAll.bind(this)}])),this}static new(e){switch(e.Method){case"zFactor":return new Report_Controls(e);case"Aggregate":return new Report_Grouped(e,{Options:"full",ColumnOnly:!0});case"Grouped":return new Report_Grouped(e,{Options:"full"});case"Hits":return new Report_Hits(e,{Options:"minimum"});default:return new Report(e)}}static getBloc(e,t){let a=!1,s=0,i=e.Blocs,n=i.length;for(;!a&&s<n;)i[s].Name==t?a=!0:s++;return a?(e.Output.Tabs[s].set("Enabled"),e.Blocs[s]):(e.Result.OpenedTab=s,e.newBloc(t,s))}static*plateIterator(e){let t=e.length;for(let a=0;a<t;a++)yield e[a]}static lock(e,t){Form.open({ID:"Report_Mask",HTML:'<p><span class="Warning">Parsing in progress, please wait...<span></p><p>Processing plate <span id="Mask_PlateNumber">1</span> / '+t+"</p>",Title:"Analysis in progress...",Buttons:[{Label:"Abort",Click:function(){e.cancel()}}],onCancel:function(){e.cancel()}})}static unlock(){Form.close("Report_Mask")}static plateCount(e){let t=GetId("Mask_PlateNumber");t&&(t.innerHTML=e)}static cleanName(e){let t=e.Result.Name,a=t.lastIndexOf(".");return a>-1?this.cleanFileName(t.substring(0,a)):this.cleanFileName(t)}static cleanFileName(e){return""==e||void 0===e?"unknown":e.trim().replace(/[^a-z0-9_\-\[\]\(\)\.]/gi,"_").replace(/_{2,}/g,"_")}static saveState(e,t){e.Results.Array[t].OpenedTab=e.Output.active(),e.Output.disable()}static restoreState(e,t){let a=e.Results.Array[t].OpenedTab;void 0!==a&&e.Output.jumpTo(a)}static blocName(e){return e.ResultIndex+". "+e.Name}static hasData(e,t){let a=e.FirstBlocIndex;if(void 0===a)return!1;let s=e.Blocs[a].getSection("Plate Summary");switch(s.Type){case"Multiple":return s.Tables[0].Data.Data[0].Groups[0].DataPoints[0].includes(t);case"StatsTable":return s.Tables[0].DataArray[0].Groups[0].DataPoints[0].includes(t);default:return!1}}get Result(){let e=this.Results.Selected[0];return void 0===e?(this.Results.setValue([0]),this.Results.Selected[0]):e}get SelectedPlate(){return this.UI.Plate.Selected.toString()}get FirstBlocIndex(){let e=this.Results.SelectedIndices[0]+1+". ",t=!1,a=0,s=this.Blocs,i=s.length;for(;!t&&a<i;)s[a].Name.startsWith(e)?t=!0:a++;return t?a:void 0}get Params(){return this.Result.Parameters}init(){return Object.values(this.UI).forEach((function(e){e.init()})),this.setPlates(),this.do(),this}do(){}prepareDefinition(){return GetId(this.Anchors.PlateSelect).insertAdjacentHTML("afterend",'<fieldset style="margin-top: 5px;"><legend>Definitions</legend><div id="Definitions_Select"><i>None available</i></div></fieldset>'),this.Ranges.forEach((function(e,t){let a=e.Definition;if(void 0!==a){let e=LinkCtrl.new("Select",{ID:"Definitions_Select",NewLine:!0,Index:t,Default:0,List:a.PlatesID,Label:a.Area.Name,Title:"The plate to use for the resolution of the names for this range",Change:function(e){this.resolveNames(a,t).then(function(e){this.ResolvedNames[t]=e,this.updateNames(a.Area,t)}.bind(this)),void 0!==e&&this.pairStatus(this.UI.Plate.getValue(),{Check:!0})}.bind(this)});e.List.length>1&&(e.NavBar=!0,e.Lookup={Active:!1}),t>0&&(e.Preserve=!0),this.UI["Definition_"+t]=e}}),this),this}setPlates(){let e=this.UI.Plate,t=this.Result.PlatesID;e.List=t,t.length>1?(e.NavBar=!0,e.Lookup={Active:!1}):(e.NavBar=!1,e.Lookup=void 0);let a=this.Result.LoggedPlate;return e.setValue(a),e.init(),this.pairStatus(a),this}pairStatus(e,t){let a=GetId(this.Anchors.PairingTarget);if(void 0===this.Result.Pairing)return void(a.innerHTML=Pair.unpaired().Html);let s=this.Result.Pairing.Pairs[e];if(void 0===s)return void(a.innerHTML=Pair.unpaired().Html);if(this.Ranges){s.getDefPlate(this.Ranges).forEach((function(e,a){let i=this.UI["Definition_"+e.RangeIndex];void 0!==i&&(t&&t.Check?e.DefPlateIndex==i.getValue()?s.Table[a].Broken=!1:s.Table[a].Broken=!0:(i.setValue(e.DefPlateIndex).change(),s.Table[a].Broken=!1))}),this)}let i=s.state();return a.innerHTML=i.Html,this}newBloc(e,t){let a="Bloc_"+t,s=new Bloc({Name:e,ID:a,File:this.Result.Name});return this.Blocs.push(s),this.Output.addTab({Label:e,SetActive:!0,Content:{Type:"HTML",Value:"<p>Data for Result file: "+this.Result.Name+'</p><div id="'+a+'"><span class="Warning">Initializing the report, please wait...</span></div>'}}),s.init()}cancel(){return this.Cancel=!0,this}refresh(e,t){"Rows"==e?this.refreshRows(t):(this.Blocs.forEach((function(e){e.Sections.forEach((function(e){e.update()}))})),this.updateNames())}update(){return this.Blocs.forEach((function(e){e.Sections.forEach((function(e){e.update()}))})),this}updateNames(e,t){let a=this.Ranges;void 0!==e&&(a=Array(this.Ranges.length),a[t]=e);let s=GetId("Output").getElementsByClassName("Value_PlaceHolder Header_Range"),i=s.length;for(let e=0;e<i;e++){let t=s[e],i=t.innerHTML;t.hasAttribute("RootName")?i=t.getAttribute("RootName"):t.setAttribute("RootName",i),a.forEach((function(e,a){if(void 0!==e&&void 0!==this.ResolvedNames[a]){let s=e.Name+" #",n=s.length,l=i.indexOf(s);if(l>-1){l+=n;let e=i.indexOf(" ",l),r=Number(i.substring(l,e));-1==e&&(r=Number(i.substring(l))),t.innerHTML=i.replace(s+r,this.ResolvedNames[a][r-1])}}}),this)}}getValues(e){let t={Items:0,Values:[],Params:[]},a=this.Results.SelectedIndices[0]+1;this.Params.forEach((function(e,s){e.Selected&&(t.Params.push({Index:s,Name:e.Name,ResultIndex:a,Numeric:e.Numeric}),t.Values.push([]))}),this),this.waitMessage(t.Params);let s=function(t,a,s,i,n){if(a==e){let e=t.Index;i.Params.forEach((function(t,a){t.Numeric?i.Values[a][e]=Number(s[t.Index]):i.Values[a][e]=s[t.Index]}))}};return new Promise(function(e){this.Result.Mapper.scan(this.Result,{Custom:s},t).then((function(t){e(t)}))}.bind(this))}waitMessage(e){e.forEach((function(e,t){Report.getBloc(this,Report.blocName(e)).Sections.forEach((function(e){void 0===e.Summary&&e.replaceContent('<br><span class="Warning">Parsing values, please wait...</span>')}))}),this)}refreshRows(e){let t="unset";e.Collapse&&(t=Analyzer.divHeight(e.Rows));let a=GetId("Output").getElementsByClassName("InnerTable_Wrapper"),s=a.length;for(let i=0;i<s;i++){let s=a[i],n=s.children[0].rows.length;s.style.maxHeight=t,n<=e.Rows?s.style.overflowY="unset":s.style.overflowY="scroll"}return this}exportAll(){let e=new JSZip,t="Form_Save";return Form.open({ID:t,HTML:'<p id="Form_Save_Output"><span class="Warning">Preparing zip archive, please wait...</span></p>',Title:"Export data",Buttons:[{Label:"Close",Click:function(){Form.close(t)}}]}),this.Blocs.forEach((function(t){let a=e.folder(t.File).folder(Report.cleanFileName(t.Name));t.Sections.forEach((function(e){let t=e.export({BlobOnly:!0});a.file(Report.cleanFileName(e.Name+".txt"),t)}))})),e.generateAsync({type:"blob"}).then((function(e){let a=GetId("Form_Save_Output");if(a){let s=URL.createObjectURL(e);a.innerHTML='<p>Click on the link below to download and save your file:</p><p style="text-align: center;"><a href="'+s+'" download="ExportAll.zip">ExportAll.zip</a></p>',Form.replaceButtons(t,[{Label:"Close",Click:function(){URL.revokeObjectURL(s),Form.close(t)}}])}})),this}}class Section{constructor(e){this.ID=e.ID,this.Bloc=e.Bloc,this.Name=e.Name,this.Data=void 0,this.Type=e.Type||"Single",void 0!==e.Summary&&(this.Summary=!0);let t=e.JSON;switch(this.Type){case"StatsTable":this.Tables=[],t.Wrapping?t.Wrapping.Data.Groups.forEach((function(e,a){let s=this.ID+"_DT_"+a;this.Tables.push(new StatsTable(s,e,t))}),this):this.Tables.push(new StatsTable(this.ID+"_DT_0",void 0,t));break;case"Multiple":this.Tables=[],t.forEach((function(e,t){let a=this.ID+"_MT_"+t;this.Tables.push(new CustomTable(a,e))}),this)}return this}static fullName(e){let t=[e.Bloc.File,e.Bloc.Name,e.Name].map((function(e){return Report.cleanFileName(e)}));return("("+t[0]+")_"+t[1]+"_["+t[2]+"]").replace(/_{2,}/g,"_")}static fileHeader(e){let t="[File metadata]\n";t+="Result file: "+e.Bloc.File+"\n",t+="Parameter: "+e.Bloc.Name+"\n",t+="Table: "+e.Name+"\n",t+="Plate: "+Analyzer.Report.UI.Plate.Selected+"\n";let a=Analyzer.Report.Ranges;void 0!==a&&a.length>0&&a.forEach((function(e,a){let s=Analyzer.Report.UI["Definition_"+a];void 0!==s&&(t+="Definition plate for range '"+e.Name+"': "+s.Selected+"\n")}));let s=Analyzer.Report.UI.DataView.Selected;return void 0!==s&&(t+="Aggregation: "+s+"\n"),t+"\n[Data]\n"}get TablesHtml(){let e="<div>";return this.Tables.forEach((function(t){e+=t.html()})),e+="</div>",e}HTML(e){let t="";switch(t+="<fieldset><legend>"+e+'</legend><div class="Section_Controls"></div><div id="'+this.ID+'" class="Section">',this.Type){case"Multiple":case"StatsTable":t+=this.TablesHtml}return t+="</div></fieldset>",t}activateControls(){GetId(this.ID).previousSibling.append(LinkCtrl.buttonBar([{Label:"Export",Title:"Click to export the data for this section",Click:function(){this.export({FileName:Section.fullName(this)})}.bind(this)},{Label:"Printable version",Title:"Click to view the data in a new window, allowing for printing or easy copy-pasting in other applications",Click:function(){this.printable()}.bind(this)}]))}replaceContent(e){return GetId(this.ID).innerHTML=e,this}update(e){switch(this.Type){case"StatsTable":case"Multiple":return this.replaceContent(this.TablesHtml),this;default:let t={};t=e||JSON.parse(this.Data),this.replaceContent(Analyzer.exportJSON(t,"html"))}return this}export(e){let t=Section.fileHeader(this);switch(this.Type){case"Multiple":case"StatsTable":this.Tables.forEach((function(e,a){a>0&&(t+="\n"),t+="\n"+e.TitleExport+"\n",t+=Analyzer.exportJSON(e.buildJSON(),"txt")}));break;default:let e=JSON.parse(this.Data);t+=Analyzer.exportJSON(e,"txt")}if(e&&e.TxtOnly)return t;if(e&&e.BlobOnly){return new Blob([t],{type:"text/plain;charset=utf-8"})}let a="Results.txt";return e&&e.FileName&&(a=e.FileName+".txt"),Form.download(t,{FileName:a}),this}printable(){return Reporter.printable(GetId(this.ID).innerHTML),this}addRow(e,t,a){if(void 0!==this.Tables)return this.Tables.forEach((function(s,i){s.addRow(e.Data[i],t,a)})),this;console.warn("This section has no Tables defined to push new row!",this)}resolveNames(e){let t=GetId(this.ID),a=t.parentElement.getElementsByClassName("ResolveStatus")[0];if(0==e.Count){let t=LinkCtrl.button({Label:"Cancel",Click:function(){this.Stop=!0}.bind(e.Report),Title:"Click here to stop the name resolution process"});a.innerHTML="<span></span><span></span>&nbsp;",a.append(t),a.children[0].innerHTML="Resolving range names, please wait... "}else a.children[1].innerHTML="( Plate "+e.Count+" / "+e.Total+")&nbsp;";let s=t.getElementsByClassName("Resolvable"),i=s.length;for(let t=0;t<i;t++){let a=s[t];if(a.getAttribute("rangename")==e.Range.Name){let t=a.parentElement.parentElement.rowIndex,s=this.Tables[0].Data.Data[0].Groups;if(s[1].DataPoints[0][t]==e.Plate){let i=JSON.parse(a.getAttribute("well")),n=e.Names[i.Index];null!=n&&n.length>0&&(a.innerHTML=n,s[3].DataPoints[0][t]=n)}}}return this}}class StatsTable{constructor(e,t,a){this.ID=e,this.Group=t;let s=a.Data[0].Groups.length;this.Length=s,this.SubGroups=[],this.DataArray=[{Groups:[{Name:"Plate Name",DataPoints:[[]]}],SubGroups:[]}];for(let e=0;e<s;e++){let e={Groups:[],SubGroups:[]};Coordinate.statObject(!0).forEach((function(t){e.Groups.push({Name:t.Name,DataPoints:[[]]})}),this),this.DataArray.push(e)}return void 0!==a.Headers&&(this.Wrap_Headers=[null].concat(a.Headers.Cols)),this.Wrap_Groups=[{Name:""}].concat(a.Data[0].Groups),this}get Title(){if(void 0!==this.Group){let e=Analyzer.getConfig("html");switch(this.Group.Type){case"Conc":let t=Analyzer.header(this.Group,e),a=Analyzer.valueHeader(this.Group,e).replaceAll("th","span");return"MOI"==this.Group.Unit?t+" "+a:a+" "+t;case"Range":return Analyzer.valueHeader(this.Group,e).replaceAll("th","span");default:return this.Group.Name}}return"Plate Summary"}get TitleExport(){return GetId(this.ID).getElementsByClassName("DynTable_Title")[0].innerText}html(){let e="";return e+='<div id="'+this.ID+'" class="DynTable_Wrap">',e+='<fieldset class="DynTable_Container">',e+='<legend class="DynTable_Title">'+this.Title+"</legend>",e+=Analyzer.exportJSON(this.buildJSON(),"html"),e+="</fieldset>",e+="</div>",e}buildJSON(){let e={Data:this.DataArray,Wrapping:{Data:{Groups:this.Wrap_Groups,SubGroups:[]}},StatRows:!0,SyncScrolling:!0,GenericRangeName:!0};return void 0!==this.Wrap_Headers&&(e.Wrapping.Headers={Cols:this.Wrap_Headers}),e}addRow(e,t,a){return this.hasData(t)||this.DataArray.forEach((function(s,i){if(0==i)s.Groups[0].DataPoints[0].push(t);else{let t={};t=void 0!==a&&void 0!==a.Stats?a.Stats[i-1]:Coordinate.statValue(e.Groups[i-1].DataPoints[0]),Coordinate.statObject(!0).forEach((function(e,a){s.Groups[a].DataPoints[0].push(t[e.Name])}))}})),this}hasData(e){let t=!1,a=this.DataArray[0].Groups[0].DataPoints[0],s=0,i=a.length;for(;!1===t&&s<i;)a[s]==e&&(t=!0),s++;return t}}class WrapTable{constructor(e){return this.Headers=e.Headers,this.Data=e.Data,this}static export_StatRows(e,t){let a="",s=t.Format,i=[];return void 0!==e.Stats?i=e.Stats:e.Data.forEach((function(e){e.Groups.forEach((function(e,t){let a=Coordinate.statValue(e.DataPoints[0]);i.push(a)}))})),Coordinate.headerObject("Col",t.CV).forEach((function(e,n){a+=Analyzer.rowStart(s),a+="txt"==s?e.Name+"\t":'<th Class="TotalRows">'+e.Name+"</th>",i.forEach((function(i,n){a+=Analyzer.cellForValue(i[e.Name],t,e),"txt"==s&&(a+="\t")})),a+=Analyzer.rowEnd(s)})),a}export(e,t){let a=Analyzer.tableStart(t.Format),s=this.Data.SubGroups.length,i=e.Data[0].SubGroups.length;a+=this.colHeaders(e,t);let n={RowCycle:s||1,RowValues:i||1,HeadTrack:{Index:0,HeaderIndex:0},WrapTrack:{Index:0,HeaderIndex:0}},l=n.RowCycle*n.RowValues;t.Gap=this.rowTxtGaps(e);for(let s=0;s<l;s++)a+=Analyzer.rowStart(t.Format),a+=this.rowHeaders(e,s,n,t),a+=this.rowData(e,s,n,t),a+=Analyzer.rowEnd(t.Format);return 0==s&&0==i&&e.StatRows&&(a+=WrapTable.export_StatRows(e,t)),a+=Analyzer.tableEnd(t.Format),a}colHeaders(e,t){let a="",s=t.Format,i=0;if(this.Data.SubGroups.length>0&&(void 0!==this.Headers&&void 0!==this.Headers.Rows?i+=2:i++),0==this.Data.Groups.length){let a=e.Data[0];return t.ColumnsLength=a.Groups.map((function(e){return e.DataPoints.reduce((function(e,t){return Math.max(e,t.length)}),0)})),GroupTable.export_ColHeaders(a,t,e.Headers,i)}void 0!==e.Headers&&void 0!==e.Headers.Rows?i+=2:i++;let n=Analyzer.blankCell(s).repeat(i),l=Array(4).fill(""),r=[];if(this.Data.Groups.forEach((function(a,i){t.ColumnsLength=e.Data[i].Groups.map((function(e){return e.DataPoints.reduce((function(e,t){return Math.max(e,t.length)}),1)})),l[3]+=Group.colValueHeaders(e.Data[i],t),void 0!==e.Headers&&void 0!==e.Headers.Cols&&(l[2]+=Group.colHeaders(e.Headers.Cols,t));let n=e.Data[i].Groups.length,o=n;if("txt"==s)switch(t.Aggregation){case"Row":o=t.ColumnsLength.reduce((function(e,t){return e+t}),0);break;case"Avg, SD, N":o=3*n}r.push(o),l[1]+=Analyzer.valueHeader(a,t,o)})),void 0!==this.Headers&&void 0!==this.Headers.Cols){t.ColumnsLength=[];let e=0;this.Headers.Cols.forEach((function(a){let i=0,n=1;null!=a&&(n=a.Span);for(let t=0;t<n;t++)i+=r[t+e];if(null!=a)switch(s){case"html":l[0]+='<th colspan="'+i+'">'+Analyzer.header(a,t)+"</th>";break;case"txt":l[0]+=Analyzer.header(a,t)+Analyzer.blankCell("txt").repeat(i)}else switch(s){case"html":l[0]+=Analyzer.blankHeader("html",{Dir:"Col",Span:i});break;case"txt":l[0]+=Analyzer.blankCell("txt").repeat(i)}e+=n}))}return l.forEach((function(e){e.length>0&&(a+=Analyzer.rowStart(s)+n+e+Analyzer.rowEnd(s))})),a}rowHeaders(e,t,a,s){let i="",n=s.Format;if(0==this.Data.SubGroups.length&&0==e.Data[0].SubGroups.length)return Analyzer.blankCell(n);let l=a.RowValues,r=Math.floor(t/l),o=t%l;if(void 0!==this.Headers&&void 0!==this.Headers.Rows)if(r==a.WrapTrack.Index){let e=this.Headers.Rows[a.WrapTrack.HeaderIndex];if(null!=e){switch(n){case"html":i+='<th rowspan="'+e.Span*l+'">'+Analyzer.header(e,s)+"</th>";break;case"txt":i+=Analyzer.header(e,s)+"\t"}a.WrapTrack.Index+=e.Span}else i+=Analyzer.blankHeader(n,{Span:l,Dir:"Row"}),a.WrapTrack.Index+=1;a.WrapTrack.HeaderIndex++}else"txt"==n&&(i+=Analyzer.blankCell("txt"));t%l==0?(this.Data.SubGroups.length>0&&(i+=Analyzer.valueHeader(this.Data.SubGroups[r],s,l,"Row")),t>0&&(a.HeadTrack={Index:0,HeaderIndex:0})):"txt"==n&&(i+=Analyzer.blankCell("txt"));let u=e.Data[r].SubGroups[o];return i+=GroupTable.export_RowHeader(u,o,a.HeadTrack,s,e.Headers),i}rowTxtGaps(e){let t=1;return void 0!==e.Headers&&null!==e.Headers&&void 0!==e.Headers.Rows&&t++,void 0!==this.Headers&&void 0!==this.Headers.Rows&&t++,this.Data.SubGroups.length>0&&t++,t}rowData(e,t,a,s){let i="",n=a.RowValues,l=a.RowCycle,r=t%n,o=Math.floor(t/n);if(this.Data.Groups.length>0){let t=this.Data.Groups.length*l,a=[];for(;o<t;)a.push(o),o+=l;return"txt"==s.Format&&"Column"==s.Aggregation?i+=this.export_RowData(e,a,r,s):a.forEach((function(t,a){a>0&&"txt"==s.Format&&(i+=Analyzer.blankCell("txt"));let n=e.Data[t];s.ColumnsLength=n.Groups.map((function(e){return e.DataPoints.reduce((function(e,t){return Math.max(e,t.length)}),0)})),i+=GroupTable.export_RowData(r,n,s)})),i}{let t=e.Data[o];return s.ColumnsLength=t.Groups.map((function(e){return e.DataPoints.reduce((function(e,t){return Math.max(e,t.length)}),0)})),GroupTable.export_RowData(r,t,s)}}export_RowData(e,t,a,s){let i="",n=0,l=Analyzer.blankCell("txt").repeat(s.Gap);if(t.forEach((function(t){let s=e.Data[t].Groups.reduce((function(e,t){return Math.max(e,t.DataPoints[a].length)}),0);n=Math.max(n,s)})),0==n)return Analyzer.noData("txt");for(let r=0;r<n;r++)r>0&&(i+="\n"+l),t.forEach((function(t,n){e.Data[t].Groups.forEach((function(e){let t=e.DataPoints[a][r];i+=void 0!==t?Analyzer.cellForValue(t,s):Analyzer.noData("txt"),i+="\t"}))}));return i}}class Report_Controls extends Report{constructor(e){super(e);let t=window.opener.zFactor;[t.Controls.N,t.Controls.P].forEach((function(e){e.forEach((function(e){e.Selected=!0}))}));let a="";a+='<div id="PleaseWait" style="display: none"><span class="Warning">Computing, please wait...</span><p class="Note">Table interaction is disabled while computing</p></div>',a+='<div id="PairNeeded" style="display: none"><p class="Warning">Select at least one Positive and one Negative control to continue!</p></div>',a+='<div id="SelectMenu">',a+='<fieldset style="margin-bottom: 10px"><legend>Positive</legend><div id="Ctrl_Pos"></div></fieldset>',a+='<fieldset style="margin-bottom: 10px"><legend>Negative</legend><div id="Ctrl_Neg"></div></fieldset>',a+="</div>",this.Menu.addTabs([{Label:"Controls",SetActive:!0,Content:{Type:"HTML",Value:'<div id="PleaseWait" style="display: none"><span class="Warning">Computing, please wait...</span><p class="Note">Table interaction is disabled while computing</p></div><div id="PairNeeded" style="display: none"><p class="Warning">Select at least one Positive and one Negative control to continue!</p></div><div id="SelectMenu"><fieldset style="margin-bottom: 10px"><legend>Positive</legend><div id="Ctrl_Pos"></div></fieldset><fieldset style="margin-bottom: 10px"><legend>Negative</legend><div id="Ctrl_Neg"></div></fieldset></div>'}}]),this.UI.DataView={Selected:"Column",init:function(){}},this.UI.P=new RespTable({ID:"Ctrl_Pos",Fields:["Name"],RowNumbers:!0,Multiple:!0,NoControls:!0,Array:t.Controls.P,onSelect:function(){this.Changed=!0,this.compute()}.bind(this)}),this.UI.N=new RespTable({ID:"Ctrl_Neg",Fields:["Name"],RowNumbers:!0,Multiple:!0,NoControls:!0,Array:t.Controls.N,onSelect:function(){this.Changed=!0,this.compute()}.bind(this)});let s=LinkCtrl.button({Label:"Compute all Plates",Title:"Click here to compute the Z-factor/Window summaries for all plates",Click:function(){this.zScoreAllPlates()}.bind(this)});return GetId(this.Anchors.PlateDoAll).append(s),this.ColumnOnly=!0,this}static combinationName(e,t){return"["+t.Name+"] vs ["+e.Name+"]"}get HasChanged(){return this.Changed}do(){return this.compute(),this}lockMenu(){return this.UI.N.lock(),this.UI.P.lock(),GetId("PleaseWait").style.display="block",GetId("PairNeeded").style.display="none",GetId("SelectMenu").style.display="none",this}unlockMenu(){return this.UI.N.unlock(),this.UI.P.unlock(),this.Changed=!1,GetId("PleaseWait").style.display="none",GetId("SelectMenu").style.display="block",this}pairNeeded(){return GetId("PairNeeded").style.display="block",this.unlockMenu(),this}getControlValues(e){[this.UI.N.Selected,this.UI.P.Selected].forEach((function(e){e.forEach((function(e){e.Values=[]}))}));let t=this.Results.SelectedIndices[0]+1,a={Items:0,Neg:this.UI.N.Selected,Pos:this.UI.P.Selected,Params:[]};this.Params.forEach((function(e,s){e.Selected&&e.Numeric&&(a.Params.push({Index:s,Name:e.Name,ResultIndex:t}),[a.Neg,a.Pos].forEach((function(e){e.forEach((function(e){e.Values.push([])}))})))}),this),this.waitMessage(a.Params);let s=function(t,a,s,i,n){if(a==e){let e=t.Index;[i.Neg,i.Pos].forEach((function(t){t.forEach((function(t){t.Tags.includes(e)&&i.Params.forEach((function(e,a){let i=s[e.Index];""==i?t.Values[a].push(""):t.Values[a].push(Number(i))}))}))}))}};return new Promise(function(e){this.Result.Mapper.scan(this.Result,{Custom:s},a).then((function(t){e(t)}))}.bind(this))}compute(){this.lockMenu();let e=this.UI.N.Selected[0],t=this.UI.P.Selected[0];if(void 0===e||void 0===t)return this.pairNeeded();let a=this.SelectedPlate;this.getControlValues(a).then(function(e){e.Params.forEach((function(t,s){this.valueTable(e,s,t);let i=this.processZscore(e,s,t);this.Result.PlatesID.length>1&&this.plateSummary(e,s,t,a,i)}),this),this.update(),this.unlockMenu()}.bind(this))}valueTable(e,t,a){let s=[];[e.Neg,e.Pos].forEach((function(e){e.forEach((function(e){s.push({Name:e.Name,DataPoints:[e.Values[t]]})}))}));let i={Data:[{Groups:s,SubGroups:[]}],Headers:{Cols:[{Name:"Negative Controls",Span:e.Neg.length},{Name:"Positive Controls",Span:e.Pos.length}]},StatRows:!0};return Report.getBloc(this,Report.blocName(a)).getSection("Values",{Type:"Single"}).Data=JSON.stringify(i),this}processZscore(e,t,a){let s=[],i=[],n=[];e.Neg.forEach((function(a,l){e.Pos.forEach((function(e,s){let r=Coordinate.statValue(a.Values[t]),o=Coordinate.statValue(e.Values[t]),u=this.zScoreFromStats(r,o),h=this.windowFromStats(r,o);0==l?(i.push({Name:e.Name,DataPoints:[[u]]}),n.push({Name:e.Name,DataPoints:[[h]]})):(i[s].DataPoints.push([u]),n[s].DataPoints.push([h]))}),this),s.push({Name:a.Name,DataPoints:[]})}),this);let l={Data:[{Groups:i,SubGroups:s}],Title:"Z'"},r={Data:[{Groups:n,SubGroups:s}],Title:"Window"};[l,r].forEach((function(t){t.Headers={Cols:[{Name:"Positive Controls",Span:e.Pos.length}],Rows:[{Name:"Negative Controls",Span:e.Neg.length}]}}));Report.getBloc(this,Report.blocName(a)).getSection("Performance indicators",{Type:"Multiple",JSON:[l,r]});return[l,r]}zScoreFromStats(e,t){let a=1-(t.SD+e.SD)/Math.abs(t.Average-e.Average)*3;return{Class:this.classForZ(a),Value:a}}windowFromStats(e,t){let a=e.Average,s=t.Average,i=Math.max(a,s)/Math.min(a,s);return{Class:this.classForW(i),Value:i}}classForW(e){return e>2?"good":e>1?"neutral":"bad"}classForZ(e){return e>.4?"good":e>.2?"neutral":"bad"}plateSummary(e,t,a,s,i){let n=[];e.Neg.forEach((function(t,a){e.Pos.forEach((function(e,l){let r=Report_Controls.combinationName(e,t),o=i[0].Data[0].Groups[l].DataPoints[a],u=i[1].Data[0].Groups[l].DataPoints[a],h={Data:[{Groups:[{Name:"Plate",DataPoints:[[s]]},{Name:"Z'",DataPoints:[o]},{Name:"W",DataPoints:[u]}],SubGroups:[]}],Title:r,SyncScrolling:!0,StatRows:!0};n.push(h)}),this)}),this),Report.getBloc(this,Report.blocName(a)).getSection("Plate Summary",{Type:"Multiple",JSON:n,Summary:!0,Changed:this.HasChanged}).addRow({Data:n},s)}async zScoreAllPlates(){this.Cancel=!1,this.lockMenu();let e=this.UI.N.Selected[0],t=this.UI.P.Selected[0];if(void 0===e||void 0===t)return this.pairNeeded();let a=this.Result.PlatesID;Report.lock(this,a.length);let s=Report.plateIterator(a),i=s.next(),n=0;for(;0==i.done&&0==this.Cancel;){let e=i.value.toString();if(0==Report.hasData(this,e)){let t=await this.getControlValues(e);t.Params.forEach((function(a,s){this.valueTable(t,s,a);let i=this.processZscore(t,s,a);this.plateSummary(t,s,a,e,i)}),this),this.update()}this.UI.Plate.setValue(n),this.pairStatus(n),i=s.next(),n++,Report.plateCount(n+1)}return this.unlockMenu(),Report.unlock(),this}}class Report_Grouped extends Report{constructor(e,t){super(e,t);let a=window.opener.Grouped;if(this.RootID="Form_AddData",this.AvailableID=this.RootID+"_Available",this.SelectedID=this.RootID+"_Selected",this.ColumnOnly=t.ColumnOnly,this.Areas=a.Areas.map((function(e,t){return e.Available=!0,e.Category="Areas",e.OriginID=this.AvailableID+"_Areas",e.OriginIndex=t,e.Values=[{Name:e.Name,Value:e.Name,Tags:e.Tags}],e}),this),this.Ranges=a.Ranges.map((function(e,t){return e.Available=!0,e.Category="Ranges",e.OriginID=this.AvailableID+"_Ranges",e.OriginIndex=t,e}),this),this.Concentrations=a.Conc.map((function(e,t){return e.Available=!0,e.Category="Concentrations",e.OriginID=this.AvailableID+"_Concentrations",e.OriginIndex=t,e}),this),this.Menu.addTabs([{Label:"Data",SetActive:!0,Content:{Type:"HTML",Value:'<div id="Report_Ready"><span class="Warning">Resolving definitions, please wait...</span></div><div id="Report_Alert" class="Warning"></div><fieldset id="AddRowCol"><div id="Data_Options"></div></fieldset>'}}]),this.UI.Selected={init:function(){},Rows:[[],[]],Cols:[[],[]]},this.ColumnOnly){this.UI.DataView=LinkCtrl.new("Select",{ID:"Data_Options",Default:0,Label:"Aggregation",List:["Column"],Preserve:!0,Title:"Multiple values will be displayed arrayed in a single column"});let e=LinkCtrl.button({Label:"Compute all Plates",Title:"Click here to compute the statistical summaries for all plates",Click:function(){this.statsAllPlates()}.bind(this)});GetId(this.Anchors.PlateDoAll).append(e)}else this.UI.DataView=LinkCtrl.new("Select",{ID:"Data_Options",Default:0,Label:"Aggregation",List:["Avg, SD, N","Average","Column","Row"],Preserve:!0,Change:this.update.bind(this),Title:"Indicates how multiple values are displayed in the grouped table: arrayed in a single column or in consecutive rows; show only the average; show the average, standard deviation and number of samples"});let s=LinkCtrl.buttonBar([{Label:"Select Data",Title:"Click here to add rows and columns of data to the summary table",Click:function(){this.addData()}.bind(this)}]);return GetId("AddRowCol").prepend(s),this.prepareDefinition(),Report_Grouped.msg_welcome(),this}static info(){return"<p class=\"Note\">Click on the 'Select Data' button located in the 'Data' panel (left menu) to add rows and columns of data</p>"}static msg_welcome(){GetId("Output").innerHTML=this.info()}static msg_pleaseWait(){GetId("Report_Alert").innerHTML='<p class="Error">Please Wait until the Range data are fully resolved!<p>'}static msg_noCol(){GetId("Report_Alert").innerHTML='<p class="Error">Please Select at least one column of data!<p>'}static msg_clear(){GetId("Report_Alert").innerHTML=""}static dragStart(e,t){e.dataTransfer.setData("text/plain",e.target.id),this.Moving={Item:Analyzer.Report[t.Category][t.OriginIndex],Origin:t.OriginID}}static dragOver(e){e.preventDefault()}static dragEnter(e){e.preventDefault();let t=e.target;0==t.classList.contains("Droppable")&&(t=t.parentElement);let a=document.getElementsByClassName("Droppable Droppable_Hover"),s=a.length;if(s>0)for(let e=0;e<s;e++)a[e].className="Droppable";t.className="Droppable Droppable_Hover"}static dragLeave(e){e.preventDefault();let t=e.target;0==t.classList.contains("Droppable")&&(t=t.parentElement);let a=e.relatedTarget;1==t.classList.contains("Droppable_Hover")&&0==a.classList.contains("SmallTitle")&&0==a.classList.contains("Selectable_Row")&&0==a.classList.contains("Droppable_Hover")&&(t.className="Droppable")}static drop(e,t){if(e.preventDefault(),void 0===this.Moving)return;GetId(e.dataTransfer.getData("text/plain")).remove(),this.Moving.Item.Available=!1,this.Moving.Item.NewDrop=t,this.Moving=void 0,Analyzer.Report.updateSelectedData({Action:"Drop"})}static dropDelete(e){if(e.preventDefault(),void 0===this.Moving)return;this.Moving.Item.Available=!0,this.Moving.Item.NewDrop={Type:"Removed"};let t=GetId(e.dataTransfer.getData("text/plain"));GetId(this.Moving.Origin).appendChild(t),this.Moving=void 0,Analyzer.Report.updateSelectedData({Action:"Drop"})}get HasChanged(){let e=!0,t=JSON.stringify(this.UI.Selected,["Rows","Cols","Name"]);return this.Selection==t&&(e=!1),this.Selection=t,e}do(){return this.Ready?this.compute():this.resolveAllNames().then(function(){this.Ready=!0,GetId("Report_Ready").remove()}.bind(this)),this}addData(){let e=this.RootID,t=this.SelectedID,a=this.AvailableID,s=new TabControl({ID:this.AvailableID,Layout:"Menu",Tabs:[{Label:"Areas",Active:!0,Content:{Type:"HTML",Value:this.available("Areas",a)}},{Label:"Ranges",Content:{Type:"HTML",Value:this.available("Ranges",a)}},{Label:"Concentrations",Content:{Type:"HTML",Value:this.available("Concentrations",a)}}]}),i="";i+='<fieldset style="width:350px; overflow: auto; float: left"><legend>Data available</legend><p class="Note">Drag and drop the data from here to the table on the right panel</p><div id="'+a+'"></div></fieldset>',i+='<fieldset style="margin-left: 400px;"><legend>Selected</legend><div id="'+t+'"></div></fieldset>',Form.open({ID:this.RootID,Size:900,Title:"Add Data",HTML:i,Buttons:[{Label:"Ok",Click:function(){this.updateSelectedData({Action:"Ok"}),Form.close(e)}.bind(this)},{Label:"Cancel",Click:function(){this.updateSelectedData({Action:"Cancel"}),Form.close(e)}.bind(this)}],onInit:function(){s.init(),GetId(t).innerHTML=this.selected()}.bind(this),onCancel:function(){this.updateSelectedData({Action:"Cancel"})}.bind(this)})}htmlForItem(e){let t="",a=e.Name;return e.Unit&&(a=e.Unit+" ("+e.Values.length+" values)"),"Range"==e.Type&&(a+=" ("+e.Values.length+" items)"),t+='<div id="'+e.OriginID+"_"+e.OriginIndex+'" draggable="true" ondragstart="Report_Grouped.dragStart(event, {Category: \''+e.Category+"', OriginID: '"+e.OriginID+"', OriginIndex: '"+e.OriginIndex+'\'})" class="Selectable_Row"',t+=">"+a+"</div>",t}available(e,t){let a='<div id="'+(t+"_"+e)+'" style="border-top: 1px solid silver">';return this[e].forEach((function(e){e.Available&&(a+=this.htmlForItem(e))}),this),a+="</div>",a}selected(e){let t=e;void 0===e&&(t=this.UI.Selected);let a="<table>";return a+='<tr> <td style="width: 1.1em"></td> <td></td> <td style="text-align: center"><div style=width: 194px;"><b>Columns</b></div>',a+='<div class="Droppable" ondrop="Report_Grouped.drop(event, {Type: \'Cols\', Level: 2})" ondragover="Report_Grouped.dragOver(event)" ondragenter="Report_Grouped.dragEnter(event)" ondragleave="Report_Grouped.dragLeave(event)" style=" ',0==t.Cols[0].length&&(a+=" display: none;"),this.ColumnOnly&&(a+=" float: none;"),a+='"><p class="SmallTitle" style="color: darkred">Level 2</p>',t.Cols[1].forEach((function(e){a+=this.htmlForItem(e)}),this),a+="</div>",a+='<div class="Droppable" ondrop="Report_Grouped.drop(event, {Type: \'Cols\', Level: 1})" ondragover="Report_Grouped.dragOver(event)" ondragenter="Report_Grouped.dragEnter(event)" ondragleave="Report_Grouped.dragLeave(event)"',a+='style=" "><p class="SmallTitle" style="color: blue">Level 1</p>',t.Cols[0].forEach((function(e){a+=this.htmlForItem(e)}),this),a+="</div>",a+="</td> </tr>",a+="<tr>",this.ColumnOnly?a+="<td></td> <td>":(a+='<td style="writing-mode: sideways-lr; width: 1.1em;"><b>Rows</b></div></td><td>',a+='<div class="Droppable" ondrop="Report_Grouped.drop(event, {Type: \'Rows\', Level: 2})" ondragover="Report_Grouped.dragOver(event)" ondragenter="Report_Grouped.dragEnter(event)" ondragleave="Report_Grouped.dragLeave(event)" style=" ',0==t.Rows[0].length&&(a+=" display: none"),a+='"><p class="SmallTitle" style="color: darkred">Level 2</p>',t.Rows[1].forEach((function(e){a+=this.htmlForItem(e)}),this),a+="</div>",a+='<div class="Droppable" ondrop="Report_Grouped.drop(event, {Type: \'Rows\', Level: 1})" ondragover="Report_Grouped.dragOver(event)" ondragenter="Report_Grouped.dragEnter(event)" ondragleave="Report_Grouped.dragLeave(event)"',a+='style=" "><p class="SmallTitle" style="color: blue">Level 1</p>',t.Rows[0].forEach((function(e){a+=this.htmlForItem(e)}),this),a+="</div>"),a+='</td><td ondrop="Report_Grouped.dropDelete(event)" ondragover="Report_Grouped.dragOver(event)" style="text-align: center">',a+='<div class="LinkCtrl_Icon LinkCtrl_IconBig" style="background-position: -200px 0px; opacity: 20%"></div>',a+='<p class="Note" >Drop here to remove</p></td> </tr>',a+="</table>",a}updateSelectedData(e){if(void 0===e)return;let t=[this.Areas,this.Ranges,this.Concentrations],a={Rows:[[],[]],Cols:[[],[]]};return"Cancel"==e.Action&&t.forEach((function(e){e.forEach((function(e){e.NewDrop=void 0,void 0!==e.Drop?e.Available=!1:e.Available=!0}))})),"Ok"==e.Action&&(t.forEach((function(e){e.forEach((function(e){void 0!==e.NewDrop&&("Removed"==e.NewDrop.Type?e.Drop=void 0:e.Drop=e.NewDrop,e.NewDrop=void 0),void 0!==e.Drop&&a[e.Drop.Type][e.Drop.Level-1].push(e)}))})),this.UI.Selected=a,this.compute()),"Drop"==e.Action&&(t.forEach((function(e){e.forEach((function(e){void 0!==e.NewDrop&&"Removed"!=e.NewDrop.Type?a[e.NewDrop.Type][e.NewDrop.Level-1].push(e):void 0===e.Drop||void 0!==e.NewDrop&&"Removed"==e.NewDrop.Type||a[e.Drop.Type][e.Drop.Level-1].push(e)}))})),a=this.cleanSelected(a),GetId(this.SelectedID).innerHTML=this.selected(a)),this}cleanSelected(e){return[e.Rows,e.Cols].forEach((function(e){0==e[0].length&&e[1].length>0&&(e[0]=e[1],e[0].forEach((function(e){void 0!==e.NewDrop&&(e.NewDrop.Level=1),void 0!==e.Drop&&(e.Drop.Level=1)})),e[1]=[])})),e}resolveAllNames(){let e=[];return new Promise(function(t){this.Ranges.forEach((function(t,a){let s=t.Definition;void 0!==s?e.push(this.resolveNames(s,a)):e.push(void 0)}),this),Promise.all(e).then(function(e){this.ResolvedNames=e,t()}.bind(this))}.bind(this))}resolveNames(e,t){let a=e.Area,s=a.MaxRange,i={Plate:this.UI["Definition_"+t].Selected,Factor:s,Default:"",AreaName:a.Name,Column:e.Mapping[Mapper.definition().Name],RangeIndexBase0:a.MaxRange,FindAll:!0};return new Promise(function(a){e.Mapper.find(e,i).then(function(s){switch(Mapper.modeWellPlate(e.Mapping)){case"Plate":case"Direct":a(s);break;case"Well":case"PlateWell":let e=[];this.Ranges[t].Values.forEach((function(t){e.push(s[t.Tags[0]])})),a(e)}}.bind(this))}.bind(this))}isReady(e,t){return 0==t[0].length?(Report_Grouped.msg_noCol(),!1):1!=this.Ready?(Report_Grouped.msg_pleaseWait(),!1):(Report_Grouped.msg_clear(),!0)}compute(){let e=this.UI.Selected.Rows,t=this.UI.Selected.Cols;if(0==this.isReady(e,t))return this;let a=this.SelectedPlate;return this.getValues(a).then(function(s){s.Params.forEach((function(i,n){let l=Report.getBloc(this,Report.blocName(i)).getSection("Values",{Type:"Single"}),r=Analyzer.encodeJSON(e,t,s.Values[n]);if(l.Data=JSON.stringify(r),this.ColumnOnly&&this.Result.PlatesID.length>1){Report.getBloc(this,Report.blocName(i)).getSection("Plate Summary",{Type:"StatsTable",Summary:!0,JSON:r,Changed:this.HasChanged}).addRow(r,a)}}),this),this.update()}.bind(this)),this}async statsAllPlates(){let e=this.UI.Selected.Rows,t=this.UI.Selected.Cols;if(0==this.isReady(e,t))return this;this.Cancel=!1;let a=this.Result.PlatesID;Report.lock(this,a.length);let s=Report.plateIterator(a),i=s.next(),n=0;for(;0==i.done&&0==this.Cancel;){let a=i.value;if(0==Report.hasData(this,a)){let s=await this.getValues(a);s.Params.forEach((function(i,n){let l=Report.getBloc(this,Report.blocName(i)).getSection("Values",{Type:"Single"}),r=Analyzer.encodeJSON(e,t,s.Values[n]);l.Data=JSON.stringify(r),Report.getBloc(this,Report.blocName(i)).getSection("Plate Summary",{Type:"StatsTable",Summary:!0,JSON:r,Changed:!1}).addRow(r,a)}),this),this.update()}this.UI.Plate.setValue(n),this.pairStatus(n),i=s.next(),n++,Report.plateCount(n+1)}return Report.unlock(),this}}class Report_Hits extends Report{constructor(e){super(e);let t=window.opener.Hits;this.Layout=t.Layout,this.Ranges=t.Ranges,this.Controls=t.Controls.N.concat(t.Controls.P),this.Controls.forEach((function(e){e.Stats=[]})),this.UI.DataView={Selected:"Column",init:function(){}},GetId(this.Anchors.Output).insertAdjacentHTML("beforebegin",'<fieldset><legend>Options</legend><div id="Config"></div></fieldset><div id="Start" style="margin: 10px"></div>');let a={Threshold:LinkCtrl.new("Number",{ID:"Start",Default:50,Label:"Threshold (%)",Chain:{Index:0},Title:"Indicate here the threshold to use for hit selection, as a percentage. All values above the threshold will be selected"}),Limit:LinkCtrl.new("Select",{ID:"Start",Default:3,Label:"Hit limit",Chain:{Index:1,Last:!0},List:[100,500,1e3,5e3,1e4,5e4],Title:"Limit for the number of hits that can be collected by a single parameter. The hit search will stop when any given parameter reaches this limit"}),Mode:LinkCtrl.new("Radio",{ID:"Config",Default:0,Label:"Mode",List:["Global","Plate","Custom"],Change:function(e){2==e?(GetId("Custom").style.display="block",GetId("Control").style.display="none"):(GetId("Custom").style.display="none",GetId("Control").style.display="block")},Title:"Whether the normalization should be done using the aggregated control values from the entire set of plates (Global), on a plate-by-plate basis (Plate), or a set of values manually provided (Custom)"}),ControlHigh:LinkCtrl.new("Select",{ID:"Control",Default:0,Label:"Control High (100%)",List:this.Controls.map((function(e){return e.Name})),Chain:{Index:0},Title:"Select the control to use as reference for the high percentage. The average of all its values will be used as the 100% reference"}),ControlLow:LinkCtrl.new("Select",{ID:"Control",Default:0,Label:"Control Low (0%)",List:this.Controls.map((function(e){return e.Name})),Chain:{Index:1,Last:!0},Title:"Select the control to use as reference for the low percentage. The average of all its values will be used as the 0% reference"}),CustomHigh:LinkCtrl.new("Number",{ID:"Custom",Default:0,Label:"High (100%)",Chain:{Index:0},Title:"The value to use as reference for the high percentage. Will be used as the 100% reference"}),CustomLow:LinkCtrl.new("Number",{ID:"Custom",Default:0,Label:"Low (0%)",Chain:{Index:1,Last:!0},Title:"The value to use as reference for the low percentage. Will be used as the 0% reference"})};return Object.assign(this.UI,a),GetId("Config").insertAdjacentHTML("afterend",'<div id="Control"></div><div id="Custom" style="display: none"></div>'),this.prepareDefinition(),this}static waitMsg(e,t){let a='<div class="HitStatus">';return a+='<span class="Warning">Scanning for hit values, please wait...</span>',a+='Parsed <span class="LineStatus">1</span>',a+=" / "+e+" "+t,a+='</div><div class="ResolveStatus"></div>',a}static logRange(e,t,a){e.Ranges.length>0&&e.Ranges.forEach((function(e){if(void 0!==e.Range.Definition){let s=a.find((function(t){return t.Range.Name==e.Range.Name}));void 0===s?a.push({Range:e.Range,Plate:[t]}):0==s.Plate.includes(t)&&s.Plate.push(t)}}))}static compareCtrl(e,t,a){if("Custom"==a.Mode.Selected){if(a.CustomHigh.getValue()==a.CustomLow.getValue())return!1}else if(e.Name==t.Name)return!1;return!0}do(){if(void 0===this.Ready){let e=GetId("Start"),t=LinkCtrl.button({Label:"Start",Title:"Click here to start computing the hits for all plates of the selected result file",Click:function(){this.compute()}.bind(this)});e.insertAdjacentHTML("beforeend","&nbsp;"),e.append(t),e.insertAdjacentHTML("beforeend",'&nbsp;<span id="ErrorMsg" class="Warning"></span>'),this.Ready=!0}return this}resolveNames(){return Promise.resolve(void 0)}updateNames(){return this}async compute(){this.Cancel=!1,this.Stop=!1;let e=this.Results.SelectedIndices[0],t={Items:0,Params:[],Values:[]};t.HitLimit=this.UI.Limit.Selected,this.Params.forEach((function(a,s){if(a.Selected&&a.Numeric){let i={Index:s,Name:a.Name,ResultIndex:e+1};t.Params.push(i),t.Values.push({H:[],L:[]})}}),this);let a=this.getControlHigh(e,t.Params),s=this.getControlLow(e,t.Params);if(0!=Report_Hits.compareCtrl(a,s,this.UI)){switch(GetId("ErrorMsg").innerHTML="",this.UI.Mode.Selected){case"Global":case"Custom":this.waitMessage(t.Params),await this.aggregateCtrl(a,s,e,t),this.reportControl(a,s,e,t);let i=await this.findHitsGlobal(a,s,e,t);this.update(),this.reportHits(i,t.Params,e),await this.resolveHitNames(i,t.Params,e),this.done(i,t.Params);break;case"Plate":let n=await this.findHitsLocal(a,s,e,t);this.reportHits(n,t.Params,e),await this.resolveHitNames(n,t.Params,e),this.done(n,t.Params)}return this}GetId("ErrorMsg").innerHTML="High and Low controls should not be the same! Check your inputs before continuing"}aggregateCtrl(e,t,a,s){return new Promise(function(i){if(void 0!==e.Stats[a]&&void 0!==t.Stats[a])i();else{e.Stats[a]=[],t.Stats[a]=[];let n=function(a,s,i,n,l){let r=a.Index;e.Tags.includes(r)&&n.Params.forEach((function(e,t){n.Values[t].H.push(Number(i[e.Index]))})),t.Tags.includes(r)&&n.Params.forEach((function(e,t){n.Values[t].L.push(Number(i[e.Index]))}))};this.Result.Mapper.scan(this.Result,{Custom:n},s).then((function(s){s.Params.forEach((function(i,n){e.Stats[a][n]=Coordinate.statValue(s.Values[n].H),t.Stats[a][n]=Coordinate.statValue(s.Values[n].L),s.Values[n].H=[],s.Values[n].L=[]})),i()}))}}.bind(this))}getControlHigh(e,t){if("Custom"==this.UI.Mode.Selected){let a=[];a[e]=[];let s=this.UI.CustomHigh.getValue();return t.forEach((function(t){a[e].push({Average:s,SD:"",N:""})})),{Name:"High",Tags:[],Stats:a}}{let e=this.UI.ControlHigh.Selected;return this.Controls.find((function(t){return t.Name==e}))}}getControlLow(e,t){if("Custom"==this.UI.Mode.Selected){let a=[];a[e]=[];let s=this.UI.CustomLow.getValue();return t.forEach((function(t){a[e].push({Average:s,SD:"",N:""})})),{Name:"Low",Tags:[],Stats:a}}{let e=this.UI.ControlLow.Selected;return this.Controls.find((function(t){return t.Name==e}))}}reportControl(e,t,a,s){this.Options.CV.getValue();return s.Params.forEach((function(s,i){let n=e.Stats[a][i],l=t.Stats[a][i],r={Data:[{Groups:[{Name:e.Name+" (100%)",DataPoints:[[n.N+" values"]]},{Name:t.Name+" (0%)",DataPoints:[[l.N+" values"]]}],SubGroups:[]}],StatRows:!0,Stats:[n,l]};""===n.N&&(r.Data[0].Groups[0].DataPoints[0][0]="Custom value"),""===l.N&&(r.Data[0].Groups[1].DataPoints[0][0]="Custom value"),Report.getBloc(this,Report.blocName(s)).getSection("Control summary").Data=JSON.stringify(r)}),this),this.update(),this}findHitsGlobal(e,t,a,s){let i=this.UI.Threshold.getValue(),n=i/100,l="Global Hits ("+i+"%)";"Custom"==this.UI.Mode.Selected&&(l="Custom Hits ("+i+"%)");let r=[],o=[],u=[];if(s.Params.forEach((function(s,i){let n=this.emptyJSON();n.SyncScrolling=!0,r[i]=e.Stats[a][i].Average-t.Stats[a][i].Average,o[i]=0;let u=Report.getBloc(this,Report.blocName(s)).getSection(l,{Type:"Multiple",JSON:[n],Changed:!0});GetId(u.ID).insertAdjacentHTML("beforebegin",Report_Hits.waitMsg(this.Result.Parser.SelectedRows,"lines"))}),this),r.reduce((function(e,t){return e&&0==t}),!0))return Promise.resolve({Status:"Fail",Section:l,Resolvable:[],Hits:o,Msg:"The average for the High and Low controls are the same! Check the selected controls and try again"});s.Items=0;let h=function(s,i,h,c,d){let p=s.Index,g=this.Layout[p];c.Params.forEach((function(p,m){let f=Report.getBloc(this,Report.blocName(p)).getSection(l,{Changed:!1});if(c.Items%2e3==0){GetId(f.ID).parentElement.getElementsByClassName("LineStatus")[0].innerHTML=c.Items,f.update()}if(0==g.Type||1==g.Type)return;if(0==r[m])return;let v=Number(h[p.Index]),b=0;if(b=r[m]<0?1-(e.Stats[a][m].Average-v)/r[m]:(v-t.Stats[a][m].Average)/r[m],b>=n){o[m]++;let e=[{Type:"text",Value:o[m]},i,s.Name,g.HTML,v,100*b],t=this.emptyJSON();t.Data[0].Groups.forEach((function(t,a){t.DataPoints[0]=[e[a]]})),f.addRow({Data:[t]},o[m]),Report_Hits.logRange(g,i,u),o[m]>=c.HitLimit&&(c.Overflow={Param:p.Name},d.abort())}}),this)}.bind(this);return new Promise(function(e){this.Result.Mapper.scan(this.Result,{Custom:h},s).then((function(t){let a={Status:"Done",Msg:"Done",Hits:o,Section:l,Resolvable:u};void 0!==t.Overflow&&(a.Status="Overflow",a.Msg="Hit limit ("+s.HitLimit+") reached for parameter: "+t.Overflow.Param+"; search aborted"),e(a)}))}.bind(this))}reportHits(e,t,a){return t.forEach((function(t,a){let s=Report.getBloc(this,Report.blocName(t)).getSection(e.Section),i=GetId(s.ID).parentElement.getElementsByClassName("HitStatus")[0],n="";if("Fail"==e.Status||"Overflow"==e.Status||"Aborted"==e.Status)n='<span class="Warning">'+e.Msg+"</span>",s.Tables[0].Title=e.Msg;else{let t="Found "+e.Hits[a]+" Hits";n='<span class="Success">'+t+"</span>",s.Tables[0].Title=t}i.innerHTML=n}),this),this}async resolveHitNames(e,t,a){let s=e.Resolvable.reduce((function(e,t){return e+t.Plate.length}),0),i=0,n=this.Results.Array[a].Pairing;if(void 0===n)return this.convertRangeNames(e,t),this;let l=e.Resolvable.length;for(let a=0;a<l;a++){let l=e.Resolvable[a],r=l.Range.Definition,o=Report.plateIterator(l.Plate),u=o.next();for(;0==u.done&&0==this.Stop;){let a=u.value.toString(),h=this.UI.Plate.List.findIndex((function(e){return e==a})),c=n.Pairs[h],d=r.PlatesID[0];if(void 0!==c){d=c.getPair(l.Range.Name);let n=await r.getPlate(d.Name);t.forEach((function(t){let r=Report.getBloc(this,Report.blocName(t)).getSection(e.Section);0==i&&GetId(r.ID).parentElement.getElementsByClassName("HitStatus")[0].remove(),r.resolveNames({Range:l.Range,Plate:a,Names:n,Total:s,Count:i,Report:this}),r.update()}),this)}u=o.next(),i++}if(this.Stop)return this.convertRangeNames(e,t),this}}async findHitsLocal(e,t,a,s){let i=this.UI.Threshold.getValue(),n=[],l=this.Result.PlatesID,r=l.length;s.Threshold=i/100,s.Title="Plate Hits ("+i+"%)",s.Counts=[],s.Params.forEach((function(e,t){s.Counts[t]=0;let a=this.emptyJSON();a.SyncScrolling=!0;let i=Report.getBloc(this,Report.blocName(e)).getSection(s.Title,{Type:"Multiple",JSON:[a],Changed:!0});GetId(i.ID).insertAdjacentHTML("beforebegin",Report_Hits.waitMsg(r,"plates"))}),this),Report.lock(this,r);let o=Report.plateIterator(l),u=o.next(),h=0;for(;0==u.done&&0==this.Cancel&&void 0===s.Overflow;){let i=u.value.toString();e.Stats[a]=[],t.Stats[a]=[],await this.getValuesLocal(e,t,a,s,i,n),this.plateSummary(e,t,a,s,i,h),this.getHits(e,t,a,s,i,n,h),this.update(),u=o.next(),this.UI.Plate.setValue(h),this.pairStatus(h),h++,Report.plateCount(h+1)}e.Stats[a]=void 0,t.Stats[a]=void 0,Report.unlock();let c={Status:"Done",Msg:"Done",Hits:s.Counts,Section:s.Title,Resolvable:n};return void 0!==s.Overflow?(c.Status="Overflow",c.Msg="Hit limit ("+s.HitLimit+") reached for parameter: <b>"+s.Overflow.Param+"</b>; search aborted"):!0===this.Cancel&&(c.Status="Aborted",c.Msg="Found "+s.Counts+" hits. Search aborted by user request"),c}getValuesLocal(e,t,a,s,i,n){s.Params.forEach((function(e,t){s.Values[t].P=[],s.Values[t].H=[],s.Values[t].L=[]}));let l=function(a,s,n,l,r){if(s!=i)return;let o=a.Index,u=this.Layout[o];2==u.Type||3==u.Type?l.Params.forEach((function(e,t){l.Values[t].P.push({Well:a,Value:Number(n[e.Index])})})):(e.Tags.includes(o)&&l.Params.forEach((function(e,t){l.Values[t].H.push(Number(n[e.Index]))})),t.Tags.includes(o)&&l.Params.forEach((function(e,t){l.Values[t].L.push(Number(n[e.Index]))})))}.bind(this);return new Promise(function(i){this.Result.Mapper.scan(this.Result,{Custom:l},s).then((function(s){s.Params.forEach((function(i,n){e.Stats[a][n]=Coordinate.statValue(s.Values[n].H),t.Stats[a][n]=Coordinate.statValue(s.Values[n].L)})),i()}))}.bind(this))}getHits(e,t,a,s,i,n,l){let r=s.Threshold;return s.Params.forEach((function(o,u){let h=Report.getBloc(this,Report.blocName(o)).getSection(s.Title),c=e.Stats[a][u].Average-t.Stats[a][u].Average;0!=c&&s.Values[u].P.forEach((function(l){let d=l.Value,p=l.Well,g=this.Layout[p.Index],m=0;if(m=c<0?1-(e.Stats[a][u].Average-d)/c:(d-t.Stats[a][u].Average)/c,m>=r){s.Counts[u]++;let e=[{Type:"text",Value:s.Counts[u]},i,p.Name,g.HTML,d,100*m],t=this.emptyJSON();t.Data[0].Groups.forEach((function(t,a){t.DataPoints[0]=[e[a]]})),h.addRow({Data:[t]},s.Counts[u]),Report_Hits.logRange(g,i,n),s.Counts[u]>=s.HitLimit&&(s.Overflow={Param:o.Name})}}),this),GetId(h.ID).parentElement.getElementsByClassName("LineStatus")[0].innerHTML=l+1}),this),this}done(e,t){return"Fail"==e.Status||t.forEach((function(t,a){let s=Report.getBloc(this,Report.blocName(t)).getSection(e.Section),i=GetId(s.ID).parentElement.getElementsByClassName("ResolveStatus");if(i.length>0&&(this.Stop?i[0].innerHTML='<span class="Warning">Name resolution stopped</span>':i[0].innerHTML=""),this.Cancel){let t=GetId(s.ID).parentElement.getElementsByClassName("HitStatus");t.length>0&&(t[0].innerHTML='<span class="Warning">Found '+e.Hits[a]+" Hits; Search not completed (cancelled)</span>")}}),this),this}plateSummary(e,t,a,s,i,n){let l=!1;0==n&&(l=!0),s.Params.forEach((function(s,n){let r={Type:"StatsTable",JSON:{Data:[{Groups:[{Name:e.Name+" (100%)",DataPoints:[[]]},{Name:t.Name+" (0%)",DataPoints:[[]]}],SubGroups:[]}]},Summary:!0,Changed:l};Report.getBloc(this,Report.blocName(s)).getSection("Plate Summary",r).addRow({Data:[]},i,{Stats:[e.Stats[a][n],t.Stats[a][n]]})}),this)}emptyJSON(){return{Data:[{Groups:[{Name:"#",DataPoints:[[]]},{Name:"Plate",DataPoints:[[]]},{Name:"Well",DataPoints:[[]]},{Name:"Content",DataPoints:[[]]},{Name:"Raw value",DataPoints:[[]]},{Name:"Normalized value",DataPoints:[[]]}],SubGroups:[]}]}}convertRangeNames(e,t){return t.forEach((function(t){let a=Report.getBloc(this,Report.blocName(t)).getSection(e.Section),s=GetId(a.ID).parentElement.getElementsByClassName("HitStatus");s.length>0&&s[0].remove();let i=GetId(a.ID).getElementsByClassName("Resolvable"),n=i.length;for(let e=0;e<n;e++){let t=i[e].parentElement.parentElement.rowIndex;a.Tables[0].Data.Data[0].Groups[3].DataPoints[0][t]=i[e].innerText}a.update()}),this),this}}
//# sourceMappingURL=analyzer.min.js.map
